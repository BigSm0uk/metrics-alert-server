version: '3'

# –ó–∞–¥–∞—á–∏ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å –ø–æ–º–æ—â—å—é pprof

vars:
  BIN_DIR: '{{.ROOT_DIR}}/bin'
  PROFILES_DIR: '{{.ROOT_DIR}}/profiles'
  PPROF_DIR: '{{.BIN_DIR}}/pprof'
  PPROF_URL: 'http://localhost:6060'

tasks:
  pprof:install:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç pprof –≤ –ø–∞–ø–∫—É bin"
    summary: |
      –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Google pprof –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π
    cmds:
      - |
        [ -f "{{.PPROF_DIR}}" ] || {
          mkdir -p "{{.BIN_DIR}}"
          GOBIN="{{.BIN_DIR}}" go install github.com/google/pprof@latest
        }

  pprof:save:base:
    desc: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–∑–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å –ø–∞–º—è—Ç–∏"
    summary: |
      –°–æ—Ö—Ä–∞–Ω—è–µ—Ç heap –ø—Ä–æ—Ñ–∏–ª—å –≤ profiles/base.pprof
      –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ü–ï–†–ï–î –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    cmds:
      - |
        mkdir -p "{{.PROFILES_DIR}}"
        echo "üìä –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ heap –ø—Ä–æ—Ñ–∏–ª—è..."
        curl -s "{{.PPROF_URL}}/debug/pprof/heap" > "{{.PROFILES_DIR}}/base.pprof"
        echo "‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {{.PROFILES_DIR}}/base.pprof"
        ls -lh "{{.PROFILES_DIR}}/base.pprof"
  
  pprof:save:result:
    desc: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å –ø–∞–º—è—Ç–∏"
    summary: |
      –°–æ—Ö—Ä–∞–Ω—è–µ—Ç heap –ø—Ä–æ—Ñ–∏–ª—å –≤ profiles/result.pprof
      –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ü–û–°–õ–ï –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    cmds:
      - |
        mkdir -p "{{.PROFILES_DIR}}"
        echo "üìä –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–µ–≥–æ heap –ø—Ä–æ—Ñ–∏–ª—è..."
        curl -s "{{.PPROF_URL}}/debug/pprof/heap" > "{{.PROFILES_DIR}}/result.pprof"
        echo "‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {{.PROFILES_DIR}}/result.pprof"
        ls -lh "{{.PROFILES_DIR}}/result.pprof"
  
  pprof:save:cpu:
    desc: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å CPU –ø—Ä–æ—Ñ–∏–ª—å (30 —Å–µ–∫—É–Ω–¥)"
    summary: |
      –°–æ—Ö—Ä–∞–Ω—è–µ—Ç CPU –ø—Ä–æ—Ñ–∏–ª—å –≤ profiles/cpu.pprof
      –¢—Ä–µ–±—É–µ—Ç 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
    cmds:
      - |
        mkdir -p "{{.PROFILES_DIR}}"
        echo "üìä –ó–∞–ø–∏—Å—å CPU –ø—Ä–æ—Ñ–∏–ª—è (30 —Å–µ–∫—É–Ω–¥, –æ–∂–∏–¥–∞–π—Ç–µ)..."
        curl -s "{{.PPROF_URL}}/debug/pprof/profile?seconds=30" > "{{.PROFILES_DIR}}/cpu.pprof"
        echo "‚úÖ CPU –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {{.PROFILES_DIR}}/cpu.pprof"
        ls -lh "{{.PROFILES_DIR}}/cpu.pprof"
  
  pprof:save:allocs:
    desc: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∞–ª–ª–æ–∫–∞—Ü–∏–π"
    summary: |
      –°–æ—Ö—Ä–∞–Ω—è–µ—Ç allocations –ø—Ä–æ—Ñ–∏–ª—å –≤ profiles/allocs.pprof
      –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∞–ª–ª–æ–∫–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏
    cmds:
      - |
        mkdir -p "{{.PROFILES_DIR}}"
        echo "üìä –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –∞–ª–ª–æ–∫–∞—Ü–∏–π..."
        curl -s "{{.PPROF_URL}}/debug/pprof/allocs" > "{{.PROFILES_DIR}}/allocs.pprof"
        echo "‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –∞–ª–ª–æ–∫–∞—Ü–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {{.PROFILES_DIR}}/allocs.pprof"
        ls -lh "{{.PROFILES_DIR}}/allocs.pprof"
  
  pprof:save:goroutine:
    desc: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å goroutine"
    summary: |
      –°–æ—Ö—Ä–∞–Ω—è–µ—Ç goroutine –ø—Ä–æ—Ñ–∏–ª—å –≤ profiles/goroutine.pprof
      –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –≥–æ—Ä—É—Ç–∏–Ω—ã
    cmds:
      - |
        mkdir -p "{{.PROFILES_DIR}}"
        echo "üìä –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ goroutine –ø—Ä–æ—Ñ–∏–ª—è..."
        curl -s "{{.PPROF_URL}}/debug/pprof/goroutine" > "{{.PROFILES_DIR}}/goroutine.pprof"
        echo "‚úÖ Goroutine –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {{.PROFILES_DIR}}/goroutine.pprof"
        ls -lh "{{.PROFILES_DIR}}/goroutine.pprof"
  
  pprof:save:mutex:
    desc: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫"
    summary: |
      –°–æ—Ö—Ä–∞–Ω—è–µ—Ç mutex –ø—Ä–æ—Ñ–∏–ª—å –≤ profiles/mutex.pprof
      –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—é –∑–∞ –º—É—Ç–µ–∫—Å—ã
    cmds:
      - |
        mkdir -p "{{.PROFILES_DIR}}"
        echo "üìä –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ mutex –ø—Ä–æ—Ñ–∏–ª—è..."
        curl -s "{{.PPROF_URL}}/debug/pprof/mutex" > "{{.PROFILES_DIR}}/mutex.pprof"
        echo "‚úÖ Mutex –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {{.PROFILES_DIR}}/mutex.pprof"
        ls -lh "{{.PROFILES_DIR}}/mutex.pprof"
  
  pprof:save:all:
    desc: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ —Ç–∏–ø—ã –ø—Ä–æ—Ñ–∏–ª–µ–π"
    summary: |
      –°–æ—Ö—Ä–∞–Ω—è–µ—Ç heap, cpu, allocs, goroutine –∏ mutex –ø—Ä–æ—Ñ–∏–ª–∏
    deps:
      - pprof:save:base
      - pprof:save:cpu
      - pprof:save:allocs
      - pprof:save:goroutine
      - pprof:save:mutex
  
  pprof:compare:
    desc: "–°—Ä–∞–≤–Ω–∏—Ç—å –±–∞–∑–æ–≤—ã–π –∏ —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∏–π –ø—Ä–æ—Ñ–∏–ª–∏"
    summary: |
      –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç profiles/base.pprof –∏ profiles/result.pprof
      –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–∑–Ω–∏—Ü—É –≤ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏ –ø–∞–º—è—Ç–∏ (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è = —É–ª—É—á—à–µ–Ω–∏–µ)
    cmds:
      - |
        if [ ! -f "{{.PROFILES_DIR}}/base.pprof" ]; then
          echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω {{.PROFILES_DIR}}/base.pprof"
          echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ: task pprof:save:base"
          exit 1
        fi
        if [ ! -f "{{.PROFILES_DIR}}/result.pprof" ]; then
          echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω {{.PROFILES_DIR}}/result.pprof"
          echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ: task pprof:save:result"
          exit 1
        fi
        echo "üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–∞–º—è—Ç–∏..."
        echo ""
        go tool pprof -top -diff_base="{{.PROFILES_DIR}}/base.pprof" "{{.PROFILES_DIR}}/result.pprof"
  
  pprof:analyze:heap:
    desc: "–ê–Ω–∞–ª–∏–∑ heap –ø—Ä–æ—Ñ–∏–ª—è –≤ –∫–æ–Ω—Å–æ–ª–∏"
    summary: |
      –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π pprof –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ base.pprof
    cmds:
      - |
        if [ ! -f "{{.PROFILES_DIR}}/base.pprof" ]; then
          echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω {{.PROFILES_DIR}}/base.pprof"
          exit 1
        fi
        echo "üîç –û—Ç–∫—Ä—ã—Ç–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ pprof..."
        echo "–ö–æ–º–∞–Ω–¥—ã: top, list, web, peek, quit"
        go tool pprof "{{.PROFILES_DIR}}/base.pprof"

  pprof:web:
    desc: "–û—Ç–∫—Ä—ã—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å pprof"
    deps: [ pprof:install ]
    summary: |
      –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å pprof –Ω–∞ http://localhost:9090
      –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç heap –ø—Ä–æ—Ñ–∏–ª—å —Å —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    cmds:
      - |
        echo "üåê –û—Ç–∫—Ä—ã—Ç–∏–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–∞ http://localhost:9090"
        echo "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ {{.PPROF_URL}}/debug/pprof/heap"
        "{{.PPROF_DIR}}" -http=:9090 "{{.PPROF_URL}}/debug/pprof/heap"
  
  pprof:web:compare:
    desc: "–°—Ä–∞–≤–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
    deps: [ pprof:install ]
    summary: |
      –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è base –∏ result –ø—Ä–æ—Ñ–∏–ª–µ–π
      –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç flame graph –∏ –¥—Ä—É–≥–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
    cmds:
      - |
        if [ ! -f "{{.PROFILES_DIR}}/base.pprof" ] || [ ! -f "{{.PROFILES_DIR}}/result.pprof" ]; then
          echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã {{.PROFILES_DIR}}/base.pprof –∏–ª–∏ {{.PROFILES_DIR}}/result.pprof"
          echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ: task pprof:save:base –∏ task pprof:save:result"
          exit 1
        fi
        echo "üåê –û—Ç–∫—Ä—ã—Ç–∏–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–∞ http://localhost:9090"
        echo "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ base.pprof vs result.pprof"
        go tool pprof -base="{{.PROFILES_DIR}}/base.pprof" -http=:9090 "{{.PROFILES_DIR}}/result.pprof"
  
  pprof:web:cpu:
    desc: "–ê–Ω–∞–ª–∏–∑ CPU –ø—Ä–æ—Ñ–∏–ª—è —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
    deps: [ pprof:install ]
    summary: |
      –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ CPU –ø—Ä–æ—Ñ–∏–ª—è
    cmds:
      - |
        if [ ! -f "{{.PROFILES_DIR}}/cpu.pprof" ]; then
          echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω {{.PROFILES_DIR}}/cpu.pprof"
          echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ: task pprof:save:cpu"
          exit 1
        fi
        echo "üåê –û—Ç–∫—Ä—ã—Ç–∏–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–∞ http://localhost:9090"
        go tool pprof -http=:9090 "{{.PROFILES_DIR}}/cpu.pprof"
  
  
  pprof:clean:
    desc: "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏"
    summary: |
      –£–¥–∞–ª—è–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ profiles/
    cmds:
      - |
        if [ -d "{{.PROFILES_DIR}}" ]; then
          echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π..."
          rm -rf "{{.PROFILES_DIR}}"/*
          echo "‚úÖ –ü—Ä–æ—Ñ–∏–ª–∏ —É–¥–∞–ª–µ–Ω—ã"
        else
          echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è profiles/ –ø—É—Å—Ç–∞"
        fi
  
  pprof:list:
    desc: "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏"
    summary: |
      –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ profiles/
    cmds:
      - |
        if [ -d "{{.PROFILES_DIR}}" ]; then
          echo "üìÇ –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏:"
          ls -lh "{{.PROFILES_DIR}}"/*.pprof 2>/dev/null || echo "–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π"
        else
          echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è profiles/ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        fi

