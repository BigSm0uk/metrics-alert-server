version: '3'

# Ð—Ð°Ð´Ð°Ñ‡Ð¸ Ð´Ð»Ñ Ð½Ð°Ð³Ñ€ÑƒÐ·Ð¾Ñ‡Ð½Ð¾Ð³Ð¾ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¸ Ð±ÐµÐ½Ñ‡Ð¼Ð°Ñ€ÐºÐ¾Ð²

vars:
  HEY_VERSION: 'v0.1.4'
  BIN_DIR: '{{.ROOT_DIR}}/bin'
  CONFIG_DIR: '{{.ROOT_DIR}}/config'
  BENCHMARKS_DIR: '{{.ROOT_DIR}}/benchmarks'
  HEY_DIR: '{{.BIN_DIR}}/hey'
  REQ_BODY_EXAMPLE: '{{.CONFIG_DIR}}/req.body.example.json'

tasks:
  
  hey:install:
    desc: "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ hey Ð² Ð¿Ð°Ð¿ÐºÑƒ bin"
    summary: |
      Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ hey Ð² Ð¿Ð°Ð¿ÐºÑƒ bin
    cmds:
      - |
        [ -f "{{.HEY_DIR}}" ] || {
          mkdir -p "{{.BIN_DIR}}"
          GOBIN="{{.BIN_DIR}}" go install github.com/rakyll/hey@{{.HEY_VERSION}}
        }
  
  hey:run:
    desc: "Ð—Ð°Ð¿ÑƒÑÐº hey Ð´Ð»Ñ Ð½Ð°Ð³Ñ€ÑƒÐ·Ð¾Ñ‡Ð½Ð¾Ð³Ð¾ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ"
    deps: [ hey:install ]
    summary: |
      Ð—Ð°Ð¿ÑƒÑÐº hey Ñ batch Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÐµÐ¼ Ð¼ÐµÑ‚Ñ€Ð¸Ðº (1000 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð², 50 Ð²Ð¾Ñ€ÐºÐµÑ€Ð¾Ð²)
    cmds:
      - |
        echo "ðŸš€ ÐÐ°Ð³Ñ€ÑƒÐ·Ð¾Ñ‡Ð½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ: 1000 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð², 50 Ð²Ð¾Ñ€ÐºÐµÑ€Ð¾Ð²"
        "{{.HEY_DIR}}" -m POST -T "application/json" -D "{{.REQ_BODY_EXAMPLE}}" -n 1000 -c 50 http://localhost:8080/updates/
  
  hey:run:csv:
    desc: "Ð—Ð°Ð¿ÑƒÑÐº hey Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð¾Ð¼ Ð² CSV"
    deps: [ hey:install ]
    summary: |
      Ð—Ð°Ð¿ÑƒÑÐº hey Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð¾Ð¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð² CSV Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ
    cmds:
      - |
        mkdir -p "{{.BENCHMARKS_DIR}}"
        echo "ðŸ“Š ÐÐ°Ð³Ñ€ÑƒÐ·Ð¾Ñ‡Ð½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð¾Ð¼ Ð² CSV..."
        "{{.HEY_DIR}}" -o csv -m POST -T "application/json" -D "{{.REQ_BODY_EXAMPLE}}" -n 1000 -c 50 http://localhost:8080/updates/ | tee "{{.BENCHMARKS_DIR}}/hey_results.csv"
  
  hey:run:light:
    desc: "Ð›ÐµÐ³ÐºÐ°Ñ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð»Ñ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ"
    deps: [ hey:install ]
    summary: |
      Ð—Ð°Ð¿ÑƒÑÐº Ñ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¾Ð¹ Ð´Ð»Ñ ÑÐ½ÑÑ‚Ð¸Ñ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÐµÐ¹ (30 ÑÐµÐºÑƒÐ½Ð´, 20 Ð²Ð¾Ñ€ÐºÐµÑ€Ð¾Ð²)
    cmds:
      - |
        echo "ðŸ”¬ Ð›ÐµÐ³ÐºÐ°Ñ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°: 30 ÑÐµÐºÑƒÐ½Ð´, 20 Ð²Ð¾Ñ€ÐºÐµÑ€Ð¾Ð²"
        "{{.HEY_DIR}}" -m POST -T "application/json" -D "{{.REQ_BODY_EXAMPLE}}" -z 15s -c 20 http://localhost:8080/updates/
        "{{.HEY_DIR}}" -m GET -z 15s -c 20 http://localhost:8080/
  
  hey:run:heavy:
    desc: "Ð˜Ð½Ñ‚ÐµÐ½ÑÐ¸Ð²Ð½Ð°Ñ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°"
    deps: [ hey:install ]
    summary: |
      Ð—Ð°Ð¿ÑƒÑÐº Ñ Ð²Ñ‹ÑÐ¾ÐºÐ¾Ð¹ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¾Ð¹ (10000 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð², 100 Ð²Ð¾Ñ€ÐºÐµÑ€Ð¾Ð²)
    cmds:
      - |
        echo "ðŸ’¥ Ð˜Ð½Ñ‚ÐµÐ½ÑÐ¸Ð²Ð½Ð°Ñ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°: 10000 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð², 100 Ð²Ð¾Ñ€ÐºÐµÑ€Ð¾Ð²"
        "{{.HEY_DIR}}" -m POST -T "application/json" -D "{{.REQ_BODY_EXAMPLE}}" -n 10000 -c 100 http://localhost:8080/updates/
  
  bench:run:
    desc: "Ð—Ð°Ð¿ÑƒÑÐº Ð²ÑÐµÑ… Ð±ÐµÐ½Ñ‡Ð¼Ð°Ñ€ÐºÐ¾Ð²"
    summary: |
      Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð²ÑÐµ Go Ð±ÐµÐ½Ñ‡Ð¼Ð°Ñ€ÐºÐ¸ Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ
    cmds:
      - |
        mkdir -p "{{.BENCHMARKS_DIR}}"
        echo "ðŸ“Š Ð—Ð°Ð¿ÑƒÑÐº Ð±ÐµÐ½Ñ‡Ð¼Ð°Ñ€ÐºÐ¾Ð²..."
        go test -bench=. -benchmem -benchtime=3s ./... | tee "{{.BENCHMARKS_DIR}}/baseline.txt"
  
  bench:run:storage:
    desc: "Ð‘ÐµÐ½Ñ‡Ð¼Ð°Ñ€ÐºÐ¸ storage ÑÐ»Ð¾Ñ"
    summary: |
      Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð±ÐµÐ½Ñ‡Ð¼Ð°Ñ€ÐºÐ¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ storage ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
    cmds:
      - |
        mkdir -p "{{.BENCHMARKS_DIR}}"
        go test -bench=. -benchmem ./internal/app/storage/... | tee "{{.BENCHMARKS_DIR}}/storage.txt"
  
  bench:run:repository:
    desc: "Ð‘ÐµÐ½Ñ‡Ð¼Ð°Ñ€ÐºÐ¸ repository ÑÐ»Ð¾Ñ"
    summary: |
      Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð±ÐµÐ½Ñ‡Ð¼Ð°Ñ€ÐºÐ¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ repository ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
    cmds:
      - |
        mkdir -p "{{.BENCHMARKS_DIR}}"
        go test -bench=. -benchmem ./internal/repository/... | tee "{{.BENCHMARKS_DIR}}/repository.txt"
  
  bench:run:service:
    desc: "Ð‘ÐµÐ½Ñ‡Ð¼Ð°Ñ€ÐºÐ¸ service ÑÐ»Ð¾Ñ"
    summary: |
      Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð±ÐµÐ½Ñ‡Ð¼Ð°Ñ€ÐºÐ¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ service ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
    cmds:
      - |
        mkdir -p "{{.BENCHMARKS_DIR}}"
        go test -bench=. -benchmem ./internal/service/... | tee "{{.BENCHMARKS_DIR}}/service.txt"
  
  bench:run:handler:
    desc: "Ð‘ÐµÐ½Ñ‡Ð¼Ð°Ñ€ÐºÐ¸ handler ÑÐ»Ð¾Ñ"
    summary: |
      Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð±ÐµÐ½Ñ‡Ð¼Ð°Ñ€ÐºÐ¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ handler ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
    cmds:
      - |
        mkdir -p "{{.BENCHMARKS_DIR}}"
        go test -bench=. -benchmem ./internal/handler/... | tee "{{.BENCHMARKS_DIR}}/handler.txt"
  
  bench:compare:
    desc: "Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ Ð±ÐµÐ½Ñ‡Ð¼Ð°Ñ€ÐºÐ¾Ð²"
    summary: |
      Ð¡Ñ€Ð°Ð²Ð½Ð¸Ð²Ð°ÐµÑ‚ baseline Ð¸ Ð½Ð¾Ð²Ñ‹Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð±ÐµÐ½Ñ‡Ð¼Ð°Ñ€ÐºÐ¾Ð² Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ benchstat
    cmds:
      - |
        if [ ! -f "{{.BENCHMARKS_DIR}}/baseline.txt" ]; then
          echo "âŒ ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½ baseline.txt"
          echo "Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: task bench:run"
          exit 1
        fi
        if [ ! -f "{{.BENCHMARKS_DIR}}/new.txt" ]; then
          echo "âŒ ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½ new.txt"
          echo "Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: task bench:run > benchmarks/new.txt"
          exit 1
        fi
        echo "ðŸ“Š Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ Ð±ÐµÐ½Ñ‡Ð¼Ð°Ñ€ÐºÐ¾Ð²..."
        benchstat "{{.BENCHMARKS_DIR}}/baseline.txt" "{{.BENCHMARKS_DIR}}/new.txt"

