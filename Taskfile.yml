version: '3'

includes:
  bench:
    taskfile: ./taskfiles/bench.yml
    dir: .
    flatten: true
  pprof:
    taskfile: ./taskfiles/profiling.yml
    dir: .
    flatten: true
  test:
    taskfile: ./taskfiles/test.yml
    dir: .
    flatten: true
vars:
  GCI_VERSION: 'v0.13.6'
  GOFUMPT_VERSION: 'v0.8.0'
  OAPI_CODEGEN_VERSION: 'v2.4.0'
  REDOCLY_VERSION: 'v2.7.0'
  GO_VERSION: 'v1.24.7'

  BIN_DIR: '{{.ROOT_DIR}}/bin'
  CMD_DIR: '{{.ROOT_DIR}}/cmd'
  CONFIG_DIR: '{{.ROOT_DIR}}/config'
  NODE_MODULES_DIR: '{{.ROOT_DIR}}/node_modules/.bin'
  OAPI_CODEGEN: '{{.BIN_DIR}}/oapi-codegen'
  REDOCLY: '{{.NODE_MODULES_DIR}}/redocly'
  GCI: '{{.BIN_DIR}}/gci'
  GOFUMPT: '{{.BIN_DIR}}/gofumpt'

tasks:
  install-formatters:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä—ã gci –∏ gofumpt –≤ ./bin"
    summary: |
      –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ gofumpt –∏ gci –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ bin.
      –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –æ–Ω–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.
      
      –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
        - gofumpt: –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ Go
        - gci: –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–º–ø–æ—Ä—Ç–æ–≤ Go
    cmds:
      - |
        [ -f "{{.GOFUMPT}}" ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gofumpt {{.GOFUMPT_VERSION}}...'
          GOBIN="{{.BIN_DIR}}" go install mvdan.cc/gofumpt@{{.GOFUMPT_VERSION}}
        }
        [ -f "{{.GCI}}" ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gci {{.GCI_VERSION}}...'
          GOBIN="{{.BIN_DIR}}" go install github.com/daixiang0/gci@{{.GCI_VERSION}}
        }
    status:
      - test -x "{{.GOFUMPT}}"
      - test -x "{{.GCI}}"

  format:
    desc: "–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç gofumpt + gci"
    summary: |
      –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤—Å–µ Go-—Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º gofumpt –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏–∏ –∫–æ–¥–∞
      –∏ gci –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–º–ø–æ—Ä—Ç–æ–≤, –∏—Å–∫–ª—é—á–∞—è —Ñ–∞–π–ª—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö mocks.
    deps: [ install-formatters ]
    cmds:
      - |
        echo "üßº –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ gofumpt ..."
        find . -type f -name '*.go' ! -path '*/mocks/*' ! -path '*/vendor/*' ! -path '*/node_modules/*' -exec "{{.GOFUMPT}}" -extra -w {} +
      - |
        echo "üéØ –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–º–ø–æ—Ä—Ç—ã —á–µ—Ä–µ–∑ gci ..."
        find . -type f -name '*.go' ! -path '*/mocks/*' ! -path '*/vendor/*' ! -path '*/node_modules/*' -exec "{{.GCI}}" write -s standard -s default -s "prefix(github.com/bigsm0uk)" {} +

  redoc:install:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç redocly –≤ node_modules"
    summary: |
      –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç redocly –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ bundle OpenAPI
    cmds:
      - |
        [ -f "{{.REDOCLY}}" ] || npm ci

  redoc:bundle:
    desc: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è bundle OpenAPI —á–µ—Ä–µ–∑ redocly"
    summary: |
      –°–æ–±–∏—Ä–∞–µ—Ç OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç HTML –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
    deps: [ redoc:install ]
    cmds:
      - |
        "{{.REDOCLY}}" bundle -o api/metric/openapi.bundle.yaml api/metric/openapi.yaml 
        "{{.REDOCLY}}" build-docs -o api/docs/redoc.html api/metric/openapi.yaml

  oapi:install:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç oapi-codegen –≤ ./bin"
    summary: |
      –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç oapi-codegen –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Go-–∫–æ–¥–∞ –∏–∑ OpenAPI
    cmds:
      - |
        [ -f "{{.OAPI_CODEGEN}}" ] || {
          mkdir -p "{{.BIN_DIR}}"
          GOBIN="{{.BIN_DIR}}" go install github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen@{{.OAPI_CODEGEN_VERSION}}
        }

  oapi:gen:
    desc: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ OpenAPI"
    deps: [ oapi:install, redoc:bundle ]
    cmds:
      - |
        set -e
        if [ -f "api/metric/openapi.bundle.yaml" ]; then
          echo "üöÄ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Metric API —á–µ—Ä–µ–∑ oapi-codegen"
          "{{.OAPI_CODEGEN}}" -generate types -o pkg/openapi/metric/oas_types_gen.go api/metric/openapi.bundle.yaml 2>&1
          "{{.OAPI_CODEGEN}}" -generate chi -o pkg/openapi/metric/oas_server_gen.go api/metric/openapi.bundle.yaml 2>&1
        fi

  deps:update:
    desc: "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ go.mod"
    cmds:
      - |
        echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ go.mod"
        go mod tidy

  server:build:
    desc: "–°–±–æ—Ä–∫–∞ –±–∏–Ω–∞—Ä–Ω–∏–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"
    summary: |
      –ö–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç server –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é bin/
    cmds:
      - |
        echo "üî® –°–±–æ—Ä–∫–∞ server..."
        go build -o "{{.BIN_DIR}}"/server "{{.CMD_DIR}}"/server
        echo "‚úÖ Server —Å–æ–±—Ä–∞–Ω: {{.BIN_DIR}}/server"

  agent:build:
    desc: "–°–±–æ—Ä–∫–∞ –±–∏–Ω–∞—Ä–Ω–∏–∫–∞ –∞–≥–µ–Ω—Ç–∞"
    summary: |
      –ö–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç agent –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é bin/
    cmds:
      - |
        echo "üî® –°–±–æ—Ä–∫–∞ agent..."
        go build -o "{{.BIN_DIR}}"/agent "{{.CMD_DIR}}"/agent
        echo "‚úÖ Agent —Å–æ–±—Ä–∞–Ω: {{.BIN_DIR}}/agent"

  build:all:
    desc: "–°–±–æ—Ä–∫–∞ –≤—Å–µ—Ö –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–≤"
    deps: [ server:build, agent:build ]

  server:run:
    desc: "–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ —Å PostgreSQL"
    deps: [ server:build ]
    summary: |
      –ó–∞–ø—É—Å–∫–∞–µ—Ç server —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (PostgreSQL)
    cmds:
      - |
        echo "üöÄ –ó–∞–ø—É—Å–∫ server..."
        "{{.BIN_DIR}}"/server --config="{{.CONFIG_DIR}}"/config.local.yaml

  server:run:mem:
    desc: "–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ —Å in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º"
    deps: [ server:build ]
    summary: |
      –ó–∞–ø—É—Å–∫–∞–µ—Ç server —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –≤ –ø–∞–º—è—Ç–∏
    cmds:
      - |
        echo "üöÄ –ó–∞–ø—É—Å–∫ server (in-memory)..."
        "{{.BIN_DIR}}"/server

  agent:run:
    desc: "–ó–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞"
    deps: [ agent:build ]
    summary: |
      –ó–∞–ø—É—Å–∫–∞–µ—Ç agent –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ—Ç—Ä–∏–∫
    cmds:
      - |
        echo "üöÄ –ó–∞–ø—É—Å–∫ agent..."
        "{{.BIN_DIR}}"/agent

